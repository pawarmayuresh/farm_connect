<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FarmConnect - Advanced Farming Community Platform</title>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f7f2;
      color: #333;
    }
    .header {
      background-color: #4a7c59;
      color: white;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .card h3 {
      color: #4a7c59;
      margin-top: 0;
    }
    .nav {
      background-color: #e9e5dd;
      padding: 10px 0;
    }
    .nav ul {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
      justify-content: center;
    }
    .nav li {
      margin: 0 15px;
    }
    .nav a {
      text-decoration: none;
      color: #333;
      font-weight: bold;
    }
    .nav a:hover {
      color: #4a7c59;
    }
    .button {
      background-color: #4a7c59;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    .button:hover {
      background-color: #3d6549;
    }
    .footer {
      background-color: #333;
      color: white;
      text-align: center;
      padding: 20px;
      margin-top: 40px;
    }
    .weather-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .weather-icon {
      font-size: 36px;
      margin-right: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .featured-product {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .product-image {
      width: 60px;
      height: 60px;
      background-color: #ddd;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      background-color: #e9e5dd;
      cursor: pointer;
      border-radius: 4px 4px 0 0;
      margin-right: 5px;
    }
    .tab.active {
      background-color: white;
      border-bottom: 3px solid #4a7c59;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .notification {
      background-color: #ffe8b3;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      border-left: 4px solid #f0ad4e;
    }
    .login-container {
      max-width: 400px;
      margin: 20px auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .chat-container {
      border: 1px solid #ddd;
      border-radius: 8px;
      height: 300px;
      margin-bottom: 10px;
      padding: 10px;
      overflow-y: auto;
      background-color: #f9f9f9;
    }
    .chat-message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
    }
    .user-message {
      background-color: #e2f0d9;
      margin-left: 20%;
    }
    .bot-message {
      background-color: #dce6f7;
      margin-right: 20%;
    }
    .chat-input {
      display: flex;
    }
    .chat-input input {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
    }
    .prediction-result {
      padding: 15px;
      background-color: #e2f0d9;
      border-radius: 8px;
      margin-top: 15px;
    }
    .progress-bar {
      height: 20px;
      background-color: #e9e5dd;
      border-radius: 10px;
      margin-bottom: 10px;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      background-color: #4a7c59;
      width: 75%;
    }
    .auth-options {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .prediction-chart {
      width: 100%;
      height: 200px;
      background-color: #f2f2f2;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 15px;
    }
    .ai-badge {
      background-color: #7c4a59;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 10px;
    }
    .img-upload-preview {
      width: 100%;
      height: 200px;
      background-color: #f2f2f2;
      border: 2px dashed #ddd;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    /* Added styles for auth form toggle */
    .auth-toggle {
      display: flex;
      margin-bottom: 20px;
      justify-content: center;
    }
    .auth-toggle-btn {
      padding: 10px 20px;
      background-color: #e9e5dd;
      border: none;
      cursor: pointer;
      margin: 0 5px;
      border-radius: 4px;
    }
    .auth-toggle-btn.active {
      background-color: #4a7c59;
      color: white;
    }
    .auth-form {
      display: none;
    }
    .auth-form.active {
      display: block;
    }
    .error-message {
      color: #d9534f;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    .loading-spinner {
      text-align: center;
      margin: 10px 0;
      display: none;
    }
    .success-message {
      color: #5cb85c;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Auth Page -->
  <div id="auth-page">
    <div class="header">
      <h1>FarmConnect</h1>
      <p>Advanced Farming Platform with AI & Data Analytics</p>
    </div>
    
    <div class="login-container">
      <div class="auth-toggle">
        <button class="auth-toggle-btn active" id="signin-toggle">Sign In</button>
        <button class="auth-toggle-btn" id="signup-toggle">Sign Up</button>
      </div>
      
      <!-- Sign In Form -->
      <div class="auth-form active" id="signin-form">
        <h2>Sign In to FarmConnect</h2>
        <p>Access your farming dashboard and analytics</p>
        
        <div class="form-group">
          <label for="signin-email">Email</label>
          <input type="email" id="signin-email" placeholder="Your email address">
        </div>
        
        <div class="form-group">
          <label for="signin-password">Password</label>
          <input type="password" id="signin-password" placeholder="Your password">
        </div>

        <div class="error-message" id="signin-error"></div>
        <div class="loading-spinner" id="signin-loading">Loading...</div>
        
        <button class="button" id="signin-btn">Sign In</button>
        
        <!-- <div class="auth-options">
          <button class="button" id="google-signin" style="background-color: #db4437;">Sign in with Google</button>
          <button class="button" id="facebook-signin" style="background-color: #3b5998;">Sign in with Facebook</button>
        </div> -->
        
        <p style="text-align: center; margin-top: 20px;">
          <a href="#" id="forgot-password">Forgot Password?</a>
        </p>
      </div>
      
      <!-- Sign Up Form -->
      <div class="auth-form" id="signup-form">
        <h2>Create a FarmConnect Account</h2>
        <p>Join our community of modern farmers</p>
        
        <div class="form-group">
          <label for="signup-name">Full Name</label>
          <input type="text" id="signup-name" placeholder="Your full name">
        </div>
        
        <div class="form-group">
          <label for="signup-email">Email</label>
          <input type="email" id="signup-email" placeholder="Your email address">
        </div>
        
        <div class="form-group">
          <label for="signup-password">Password</label>
          <input type="password" id="signup-password" placeholder="Create a password (min 6 characters)">
        </div>
        
        <div class="form-group">
          <label for="signup-confirm">Confirm Password</label>
          <input type="password" id="signup-confirm" placeholder="Confirm your password">
        </div>

        <div class="form-group">
          <label for="farm-type">Farm Type</label>
          <select id="farm-type">
            <option value="">Select your farm type</option>
            <option value="crop">Crop Farm</option>
            <option value="livestock">Livestock</option>
            <option value="dairy">Dairy</option>
            <option value="orchard">Orchard</option>
            <option value="mixed">Mixed Farm</option>
          </select>
        </div>

        <div class="error-message" id="signup-error"></div>
        <div class="loading-spinner" id="signup-loading">Loading...</div>
        <div class="success-message" id="signup-success">Account created successfully! You can now sign in.</div>
        
        <button class="button" id="signup-btn">Create Account</button>
        
        <!-- <div class="auth-options">
          <button class="button" id="google-signup" style="background-color: #db4437;">Sign up with Google</button>
          <button class="button" id="facebook-signup" style="background-color: #3b5998;">Sign up with Facebook</button>
        </div> -->
      </div>
      
      <!-- Password Reset Form -->
      <div class="auth-form" id="reset-form">
        <h2>Reset Your Password</h2>
        <p>We'll send you a password reset link</p>
        
        <div class="form-group">
          <label for="reset-email">Email</label>
          <input type="email" id="reset-email" placeholder="Your registered email address">
        </div>
        
        <div class="error-message" id="reset-error"></div>
        <div class="success-message" id="reset-success">Password reset email sent! Check your inbox.</div>
        
        <button class="button" id="reset-btn">Send Reset Link</button>
        
        <p style="text-align: center; margin-top: 20px;">
          <a href="#" id="back-to-signin">Back to Sign In</a>
        </p>
      </div>
    </div>
  </div>

  <!-- Main Application (Hidden until logged in) -->
  <div id="app-container" style="display: none;">
    <div class="header">
      <h1>FarmConnect</h1>
      <p>Advanced Farming Platform with AI & Data Analytics</p>
    </div>
    
    <div class="nav">
      <ul>
        <li><a href="#dashboard">Dashboard</a></li>
        <li><a href="#predictions">AI Predictions</a></li>
        <li><a href="#assistant">Farm Assistant</a></li>
        <li><a href="#market">Marketplace</a></li>
        <li><a href="#community">Community</a></li>
        <li><a href="#profile">My Profile</a></li>
        <li><a href="#" id="logout-btn">Logout</a></li>
      </ul>
    </div>
    
    <div class="container">
      <div class="notification">
        <strong>New!</strong> Our AI crop yield prediction model has been updated with latest weather data. Check your forecasts now!
      </div>
      
      <!-- Dashboard Section -->
      <div class="dashboard">
        <div class="card">
          <h3>Weather & AI Predictions</h3>
          <p>Powered by TensorFlow Weather Forecasting</p>
          <div class="weather-container">
            <div>
              <p><strong>Today:</strong> 75¬∞F, Sunny</p>
              <p><strong>Tomorrow:</strong> 78¬∞F, Partly Cloudy</p>
              <p><strong>AI Recommendation:</strong> Ideal day for harvesting corn</p>
            </div>
            <div class="weather-icon">‚òÄÔ∏è</div>
          </div>
          <button class="button">View Detailed Forecast</button>
        </div>
        
        <div class="card">
          <h3>Farm Health Analysis</h3>
          <p>Powered by TensorFlow Image Recognition</p>
          <div class="img-upload-preview">
            <p>Upload crop images for disease detection</p>
          </div>
          <button class="button">Upload New Image</button>
        </div>
        
        <div class="card">
          <h3>Marketplace Activity</h3>
          <p>Powered by Firebase Realtime Database</p>
          <div class="featured-product">
            <div class="product-image">ü•ï</div>
            <div>
              <h4>Organic Carrots</h4>
              <p>Current Price: $2.50/lb</p>
              <p><small>3 buyers interested</small></p>
            </div>
          </div>
          <div class="featured-product">
            <div class="product-image">üçÖ</div>
            <div>
              <h4>Heirloom Tomatoes</h4>
              <p>Current Price: $3.75/lb</p>
              <p><small>7 buyers interested</small></p>
            </div>
          </div>
          <button class="button">View Marketplace</button>
        </div>
      </div>
      
      <!-- AI Farm Assistant (Dialogflow) -->
      <div class="card" style="margin-top: 20px;">
        <h3>Farm Assistant <span class="ai-badge">Dialogflow</span></h3>
        <p>Ask questions about farming, market prices, or get recommendations</p>
        
        <div class="chat-container" id="chat-box">
          <div class="chat-message bot-message">
            Hello <span id="user-name">farmer</span>! I'm your FarmConnect Assistant. How can I help you today? You can ask me about crop recommendations, market prices, or farming techniques.
          </div>
        </div>
        
        <div class="chat-input">
          <input type="text" placeholder="Ask your farming question..." id="chat-input">
          <button class="button" id="chat-send">Send</button>
        </div>
      </div>
      
      <!-- Rest of the content same as before -->
      <!-- TensorFlow Crop Yield Prediction -->
      <div class="card" style="margin-top: 20px;">
        <h3>Crop Yield Predictions <span class="ai-badge">TensorFlow</span></h3>
        <p>AI-powered yield forecasting based on your farm's data</p>
        
        <div class="form-group">
          <label for="crop-select">Select Crop:</label>
          <select id="crop-select">
            <option>Corn</option>
            <option>Wheat</option>
            <option>Soybeans</option>
            <option>Tomatoes</option>
            <option>Carrots</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="field-select">Select Field:</label>
          <select id="field-select">
            <option>North Field (12 acres)</option>
            <option>South Field (8 acres)</option>
            <option>West Field (15 acres)</option>
          </select>
        </div>
        
        <button class="button">Generate Prediction</button>
        
        <div class="prediction-result">
          <h4>Predicted Yield: 185 bushels/acre</h4>
          <p>Confidence: High (85%)</p>
          <p><strong>Factors affecting yield:</strong></p>
          <ul>
            <li>Precipitation forecast: Favorable (+10%)</li>
            <li>Soil conditions: Optimal (+5%)</li>
            <li>Historical performance: Above average (+8%)</li>
          </ul>
        </div>
        
        <div class="prediction-chart">
          [Yield Prediction Chart - Generated by TensorFlow]
        </div>
      </div>
      
      <!-- Remaining sections unchanged... -->
    </div>
    
    <div class="footer">
      <p>FarmConnect - Powered by Firebase, TensorFlow, Dialogflow & Vertex AI</p>
      <p>Data stored securely with Firebase ‚Ä¢ ML models processed with TensorFlow</p>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script type="module">
   // Import the functions you need from the SDKs
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { 
  getAuth, 
  createUserWithEmailAndPassword, 
  signInWithEmailAndPassword, 
  onAuthStateChanged, 
  signOut, 
  GoogleAuthProvider, 
  FacebookAuthProvider, 
  signInWithPopup, 
  sendPasswordResetEmail 
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc, 
  setDoc, 
  collection, 
  addDoc, 
  query, 
  orderBy, 
  limit, 
  onSnapshot, 
  serverTimestamp 
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { 
  getStorage, 
  ref, 
  uploadBytes, 
  getDownloadURL 
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDdiN5enZ807dcOfQWBT7zazCNq-CKQmPc",
  authDomain: "farm-connect-3a30a.firebaseapp.com",
  projectId: "farm-connect-3a30a",
  storageBucket: "farm-connect-3a30a.appspot.com",
  messagingSenderId: "71932567374",
  appId: "1:71932567374:web:3644c940e33f8444bfc81f"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const googleProvider = new GoogleAuthProvider();
const facebookProvider = new FacebookAuthProvider();

// Global variables
let currentUser = null;
let userProfile = null;

// DOM Elements
const authPage = document.getElementById('auth-page');
const appContainer = document.getElementById('app-container');

// Auth toggle functionality
const signinToggle = document.getElementById('signin-toggle');
const signupToggle = document.getElementById('signup-toggle');
const signinForm = document.getElementById('signin-form');
const signupForm = document.getElementById('signup-form');
const resetForm = document.getElementById('reset-form');
const forgotPassword = document.getElementById('forgot-password');
const backToSignin = document.getElementById('back-to-signin');

signinToggle.addEventListener('click', () => {
  signinToggle.classList.add('active');
  signupToggle.classList.remove('active');
  signinForm.classList.add('active');
  signupForm.classList.remove('active');
  resetForm.classList.remove('active');
});

signupToggle.addEventListener('click', () => {
  signupToggle.classList.add('active');
  signinToggle.classList.remove('active');
  signupForm.classList.add('active');
  signinForm.classList.remove('active');
  resetForm.classList.remove('active');
});

forgotPassword.addEventListener('click', (e) => {
  e.preventDefault();
  signinForm.classList.remove('active');
  resetForm.classList.add('active');
});

backToSignin.addEventListener('click', (e) => {
  e.preventDefault();
  resetForm.classList.remove('active');
  signinForm.classList.add('active');
});

// Sign-up functionality
const signupBtn = document.getElementById('signup-btn');
const signupName = document.getElementById('signup-name');
const signupEmail = document.getElementById('signup-email');
const signupPassword = document.getElementById('signup-password');
const signupConfirm = document.getElementById('signup-confirm');
const farmType = document.getElementById('farm-type');
const signupError = document.getElementById('signup-error');
const signupLoading = document.getElementById('signup-loading');
const signupSuccess = document.getElementById('signup-success');

signupBtn.addEventListener('click', async () => {
  // Reset messages
  signupError.style.display = 'none';
  signupSuccess.style.display = 'none';
  
  // Validate form
  if (!signupName.value || !signupEmail.value || !signupPassword.value || !signupConfirm.value || !farmType.value) {
    signupError.textContent = 'Please fill in all fields';
    signupError.style.display = 'block';
    return;
  }

  if (signupPassword.value !== signupConfirm.value) {
    signupError.textContent = 'Passwords do not match';
    signupError.style.display = 'block';
    return;
  }

  if (signupPassword.value.length < 6) {
    signupError.textContent = 'Password must be at least 6 characters';
    signupError.style.display = 'block';
    return;
  }

  // Show loading
  signupLoading.style.display = 'block';
  
  try {
    // Create user with email and password
    const userCredential = await createUserWithEmailAndPassword(auth, signupEmail.value, signupPassword.value);
    const user = userCredential.user;
    
    // Store additional user data in Firestore
    await setDoc(doc(db, "users", user.uid), {
      name: signupName.value,
      email: signupEmail.value,
      farmType: farmType.value,
      createdAt: new Date().toISOString()
    });
    
    // Success
    signupLoading.style.display = 'none';
    signupSuccess.style.display = 'block';
    
    // Clear form
    signupName.value = '';
    signupEmail.value = '';
    signupPassword.value = '';
    signupConfirm.value = '';
    farmType.value = '';
    
    // Switch to signin tab after brief delay
    setTimeout(() => {
      signinToggle.click();
    }, 2000);
    
  } catch (error) {
    signupLoading.style.display = 'none';
    
    // Handle specific errors
    if (error.code === 'auth/email-already-in-use') {
      signupError.textContent = 'Email is already in use';
    } else if (error.code === 'auth/invalid-email') {
      signupError.textContent = 'Invalid email address';
    } else {
      signupError.textContent = 'Error creating account: ' + error.message;
    }
    
    signupError.style.display = 'block';
  }
});

// Sign-in functionality
const signinBtn = document.getElementById('signin-btn');
const signinEmail = document.getElementById('signin-email');
const signinPassword = document.getElementById('signin-password');
const signinError = document.getElementById('signin-error');
const signinLoading = document.getElementById('signin-loading');

signinBtn.addEventListener('click', async () => {
  // Reset messages
  signinError.style.display = 'none';
  
  // Validate form
  if (!signinEmail.value || !signinPassword.value) {
    signinError.textContent = 'Please enter both email and password';
    signinError.style.display = 'block';
    return;
  }
  
  // Show loading
  signinLoading.style.display = 'block';
  
  try {
    // Sign in user
    await signInWithEmailAndPassword(auth, signinEmail.value, signinPassword.value);
    
    // Success handled by auth state change
    signinLoading.style.display = 'none';
    
  } catch (error) {
    signinLoading.style.display = 'none';
    
    // Handle specific errors
    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
      signinError.textContent = 'Invalid email or password';
    } else if (error.code === 'auth/too-many-requests') {
      signinError.textContent = 'Too many failed attempts. Try again later';
    } else {
      signinError.textContent = 'Error signing in: ' + error.message;
    }
    
    signinError.style.display = 'block';
  }
});

// Password reset functionality
const resetBtn = document.getElementById('reset-btn');
const resetEmail = document.getElementById('reset-email');
const resetError = document.getElementById('reset-error');
const resetSuccess = document.getElementById('reset-success');

resetBtn.addEventListener('click', async () => {
  // Reset messages
  resetError.style.display = 'none';
  resetSuccess.style.display = 'none';
  
  // Validate form
  if (!resetEmail.value) {
    resetError.textContent = 'Please enter your email address';
    resetError.style.display = 'block';
    return;
  }
  
  try {
    // Send password reset email
    await sendPasswordResetEmail(auth, resetEmail.value);
    
    // Success
    resetSuccess.style.display = 'block';
    
  } catch (error) {
    // Handle specific errors
    if (error.code === 'auth/user-not-found') {
      resetError.textContent = 'No account found with this email';
    } else if (error.code === 'auth/invalid-email') {
      resetError.textContent = 'Invalid email address';
    } else {
      resetError.textContent = 'Error: ' + error.message;
    }
    
    resetError.style.display = 'block';
  }
});

// // Social login functionality
// const googleSignin = document.getElementById('google-signin');
// const facebookSignin = document.getElementById('facebook-signin');
// const googleSignup = document.getElementById('google-signup');
// const facebookSignup = document.getElementById('facebook-signup');

async function socialSignIn(provider) {
  try {
    const result = await signInWithPopup(auth, provider);
    
    // The signed-in user info
    const user = result.user;
    
    // If this is a new user, create a profile in Firestore
    const docRef = doc(db, "users", user.uid);
    await setDoc(docRef, {
      name: user.displayName || 'User',
      email: user.email,
      photoURL: user.photoURL,
      createdAt: new Date().toISOString()
    }, { merge: true });
    
  } catch (error) {
    // Handle errors
    console.error("Social sign-in error:", error);
    signinError.textContent = 'Error with social sign-in';
    signinError.style.display = 'block';
  }
}

// googleSignin.addEventListener('click', () => socialSignIn(googleProvider));
// facebookSignin.addEventListener('click', () => socialSignIn(facebookProvider));
// googleSignup.addEventListener('click', () => socialSignIn(googleProvider));
// facebookSignup.addEventListener('click', () => socialSignIn(facebookProvider));

// Logout functionality
const logoutBtn = document.getElementById('logout-btn');

logoutBtn.addEventListener('click', async () => {
  try {
    await signOut(auth);
    // UI update handled by auth state change
  } catch (error) {
    console.error("Error signing out:", error);
  }
});

// Monitor auth state changes
onAuthStateChanged(auth, async (user) => {
  if (user) {
    // User is signed in
    currentUser = user;
    
    // Get additional user data from Firestore
    try {
      const docSnap = await getDoc(doc(db, "users", user.uid));
      if (docSnap.exists()) {
        userProfile = docSnap.data();
        
        // Update UI with user data
        const userNameElement = document.getElementById('user-name');
        if (userNameElement) {
          userNameElement.textContent = userProfile.name || 'farmer';
        }
      }
    } catch (error) {
      console.error("Error fetching user data:", error);
    }
    
    // Show app, hide auth page
    authPage.style.display = 'none';
    appContainer.style.display = 'block';
    
    // Load user-specific data
    loadUserData();
    setupChatListener();
    
  } else {
    // User is signed out
    currentUser = null;
    userProfile = null;
    
    // Show auth page, hide app
    authPage.style.display = 'block';
    appContainer.style.display = 'none';
    
    // Clear any chat listeners
    if (window.chatUnsubscribe) {
      window.chatUnsubscribe();
    }
  }
});

// Load user data from Firestore
async function loadUserData() {
  if (!currentUser) return;
  
  try {
    // Load fields data
    const fieldsSnap = await getDoc(doc(db, "fields", currentUser.uid));
    if (fieldsSnap.exists()) {
      const fieldSelect = document.getElementById('field-select');
      if (fieldSelect) {
        // Clear existing options
        fieldSelect.innerHTML = '';
        
        // Add options based on user's fields
        const fields = fieldsSnap.data().fields || [];
        fields.forEach(field => {
          const option = document.createElement('option');
          option.value = field.id;
          option.textContent = `${field.name} (${field.size} acres)`;
          fieldSelect.appendChild(option);
        });
      }
    }
    
    // Load marketplace data
    // This would fetch from Firestore and update the UI
    
  } catch (error) {
    console.error("Error loading user data:", error);
  }
}

// Chat functionality with Firestore
const chatBox = document.getElementById('chat-box');
const chatInput = document.getElementById('chat-input');
const chatSendBtn = document.getElementById('chat-send');

// Setup chat listener
function setupChatListener() {
  if (!currentUser || !chatBox) return;
  
  // Reference to this user's chat messages
  const chatRef = collection(db, "chats", currentUser.uid, "messages");
  const q = query(chatRef, orderBy("timestamp", "asc"), limit(50));
  
  // Create listener
  window.chatUnsubscribe = onSnapshot(q, (snapshot) => {
    // Clear chat box
    chatBox.innerHTML = '';
    
    // Add messages
    snapshot.forEach((doc) => {
      const message = doc.data();
      const msgElement = document.createElement('div');
      msgElement.className = message.sender === 'user' ? 
        'chat-message user-message' : 'chat-message bot-message';
      msgElement.textContent = message.message;
      chatBox.appendChild(msgElement);
    });
    
    // Scroll to bottom
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

// Function to handle chat sending
async function sendChatMessage(message) {
  if (!currentUser || !message.trim()) return;
  
  try {
    // Add user message to Firestore
    await addDoc(collection(db, "chats", currentUser.uid, "messages"), {
      sender: "user",
      message: message,
      timestamp: serverTimestamp()
    });
    
    // Clear input
    chatInput.value = '';
    
    // Simulate assistant response
    setTimeout(async () => {
      let assistantResponse = "I understand your question about " + message.split(' ').slice(0,3).join(' ') + "...";
      
      // Simple pattern matching for demo
      if (message.toLowerCase().includes('weather')) {
        assistantResponse = "The weather forecast for the next 3 days is sunny with temperatures around 75¬∞F. Perfect conditions for field work!";
      } else if (message.toLowerCase().includes('price') || message.toLowerCase().includes('market')) {
        assistantResponse = "Current market prices in your area: Corn: $5.20/bushel, Soybeans: $12.40/bushel, Wheat: $6.80/bushel, Tomatoes: $3.75/lb.";
      } else if (message.toLowerCase().includes('pest') || message.toLowerCase().includes('disease')) {
        assistantResponse = "Based on reports in your area, watch for corn rootworm and early blight in tomatoes. Upload images to our pest detection tool for specific diagnosis.";
      }
      
      // Add assistant message to Firestore
      await addDoc(collection(db, "chats", currentUser.uid, "messages"), {
        sender: "assistant",
        message: assistantResponse,
        timestamp: serverTimestamp()
      });
    }, 1000);
    
  } catch (error) {
    console.error("Error sending message:", error);
  }
}

// Chat input event listeners
if (chatInput) {
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && chatInput.value.trim() !== '') {
      sendChatMessage(chatInput.value);
    }
  });
}

if (chatSendBtn) {
  chatSendBtn.addEventListener('click', () => {
    if (chatInput.value.trim() !== '') {
      sendChatMessage(chatInput.value);
    }
  });
}

// Image Upload for Pest Detection
const imageUpload = document.querySelector('input[type="file"]');
const analyzeImageBtn = document.querySelector('.button');

if (imageUpload && analyzeImageBtn) {
  analyzeImageBtn.addEventListener('click', async () => {
    if (!currentUser || !imageUpload.files || !imageUpload.files[0]) return;
    
    try {
      // Create a reference to the Firebase Storage location
      const storageRef = ref(storage, `pest-images/${currentUser.uid}/${Date.now()}-${imageUpload.files[0].name}`);
      
      // Upload the file
      const snapshot = await uploadBytes(storageRef, imageUpload.files[0]);
      
      // Get the download URL
      const imageUrl = await getDownloadURL(snapshot.ref);
      
      // Store the image analysis request in Firestore
      await addDoc(collection(db, "pest-analysis"), {
        userId: currentUser.uid,
        imageUrl: imageUrl,
        status: "pending",
        timestamp: serverTimestamp()
      });
      
      // In a real app, this would trigger a Cloud Function to process the image
      // For demo purposes, we'll show a success message
      alert("Image uploaded successfully! Analysis results will be available shortly.");
      
    } catch (error) {
      console.error("Error uploading image:", error);
      alert("Error uploading image. Please try again.");
    }
  });
}

// Initialize app buttons and functionality
document.addEventListener('DOMContentLoaded', () => {
  // Initialize all buttons with appropriate event listeners
  const actionButtons = document.querySelectorAll('.button:not([id])');
  actionButtons.forEach(button => {
    button.addEventListener('click', () => {
      alert("This feature would be fully implemented in a production environment.");
    });
  });
});


  </script>
  </body>
</html>